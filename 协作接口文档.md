# WOK Editor 协作接口文档

## 项目概述

WOK Editor 是一个基于 Vditor 的极简 Markdown 编辑器，采用 Electron 桌面应用架构，支持跨平台运行。

**项目架构**：双进程架构（主进程 + 渲染进程）
**技术栈**：Electron + Vditor + Vite
**安全策略**：严格的 CSP 策略，禁用内联脚本和 eval

## 目录结构

```
├── electron/           # 主进程代码
│   ├── main.cjs       # 主进程入口，窗口管理和文件系统IPC
│   └── preload.cjs    # 预加载脚本，安全API暴露
├── src/               # 渲染进程代码（模块化架构）
│   ├── main.js        # 渲染进程入口，模块编排（905行）
│   ├── style.css      # 全局样式
│   ├── core/          # 核心模块
│   │   └── constants.js    # 配置常量（32行）
│   ├── ui/            # UI 组件模块
│   │   ├── toast.js        # 提示消息组件（67行）
│   │   ├── sanitizer.js    # DOM安全处理（188行）
│   │   └── resizer.js      # 侧边栏拖拽（125行）
│   └── modules/       # 功能模块（待提取）
├── public/            # 静态资源
│   └── vditor/        # Vditor编辑器资源（完整分发版）
└── 配置文件和构建脚本
```

**重构进度**: 已完成 20.3% 代码拆分（1136行 → 905行）

## 端口和网络配置

### 开发服务器端口
- **端口**: 3000
- **配置文件**: `vite.config.js:6`
- **用途**: Vite 开发服务器端口

### CSP 安全策略
- **配置文件**: `index.html:10`
- **策略**:
  - `default-src 'self'` - 默认只允许同源资源
  - `img-src 'self' data: https:` - 图片资源策略
  - `style-src 'self' 'unsafe-inline'` - 样式策略（Vditor需要）
  - `script-src 'self' 'sha256-qR4U4J3Ne5n0m3uNzGMB/tZ3TWJUf89OlxdXqjqALDM='` - 脚本策略（包含Vditor所需哈希）
  - `font-src 'self' data: https:` - 字体策略（支持浏览器扩展）
  - `connect-src 'self' ws: wss:` - 连接策略
  - `worker-src 'self' blob:` - Worker策略
  - `object-src 'self' data:` - 对象策略
- **禁用功能**: 数学公式渲染（MathJax违反CSP）
- **安全文档**: 详见 `CSP-SECURITY.md`

## IPC 通信接口

### 主进程 IPC 处理器
**文件**: `electron/main.cjs:429-525`

| 通道 | 类型 | 参数 | 返回值 | 功能描述 |
|------|------|------|--------|----------|
| `file:save` | handle | `content: string` | `成功: {success: true, filePath: string}`<br>`取消: {success: false, canceled: true}`<br>`失败: {success: false, error: string, code: string}` | 保存文件到当前路径或显示保存对话框 |
| `file:save-as` | handle | `content: string` | `成功: {success: true, filePath: string}`<br>`取消: {success: false, canceled: true}`<br>`失败: {success: false, error: string, code: string}` | 显示另存为对话框并保存文件 |
| `file:auto-save` | handle | `content: string` | `成功: {success: true, filePath: string}`<br>`失败: {success: false, error: string, code: string}` | 自动保存到 autosave 文件夹 |
| `file:set-dirty` | on | `isDirty: boolean` | 无 | 设置编辑器脏状态 |

### 渲染进程 IPC 监听器
**文件**: `electron/preload.cjs:12-21`

| 通道 | 类型 | 参数 | 功能描述 |
|------|------|------|----------|
| `menu:new-file` | on | 无 | 新建文件操作 |
| `menu:open-file` | on | `{filePath: string, content: string}` | 打开文件操作 |
| `menu:save-file` | on | 无 | 保存文件操作 |
| `menu:save-as-file` | on | 无 | 另存为文件操作 |

### 预加载脚本暴露的 API
**文件**: `electron/preload.cjs:12-21`

```javascript
window.electronAPI = {
  // 事件监听器
  onNewFile: (listener) => exposeListener('menu:new-file', listener),
  onOpenFile: (listener) => exposeListener('menu:open-file', listener),
  onSaveFile: (listener) => exposeListener('menu:save-file', listener),
  onSaveAsFile: (listener) => exposeListener('menu:save-as-file', listener),

  // 异步操作
  saveFile: (content) => ipcRenderer.invoke('file:save', content),
  saveFileAs: (content) => ipcRenderer.invoke('file:save-as', content),
  autoSaveFile: (content) => ipcRenderer.invoke('file:auto-save', content),

  // 状态同步
  setDirty: (isDirty) => ipcRenderer.send('file:set-dirty', Boolean(isDirty))
}
```

## 关键函数和方法

### 主进程函数 (`electron/main.cjs`)

#### 文件操作函数
- `assertSafeFilePath(targetPath)` - 验证文件路径安全性
- `readRendererFile(filePath, options)` - 读取文件内容
- `writeContentToFile(targetPath, content)` - 写入文件内容
- `ensureSavePath(defaultPath)` - 获取保存路径

#### 窗口管理函数
- `createWindow()` - 创建主窗口
- `updateWindowTitle()` - 更新窗口标题
- `buildMenuTemplate()` - 构建应用菜单

#### 工具函数
- `translateFileSystemError(error)` - 错误消息转换
- `buildErrorResponse(error)` - 构建错误响应
- `registerIpcHandlers()` - 注册IPC处理器

### 渲染进程函数（模块化架构）

#### 核心常量模块 (`src/core/constants.js`)
- `isDev` - 开发模式标志
- `isElectron` - Electron环境检测
- `MAX_INLINE_IMAGE_SIZE` - 内联图片大小限制
- `TOAST_DISPLAY_DURATION` - 提示显示时长
- `OUTLINE_MIN_WIDTH/MAX_WIDTH` - 侧边栏宽度限制
- `AUTO_SAVE_DELAY` - 自动保存延迟

#### UI 组件模块
**Toast 提示组件** (`src/ui/toast.js`):
- `showToast(message)` - 显示提示消息
- 自动管理生命周期和动画

**DOM 安全模块** (`src/ui/sanitizer.js`):
- `installInlineEventAttributeGuard()` - 安装内联事件防护
- `sanitizeInlineHandlers(root)` - 清理内联事件处理器
- `observeAndSanitizeInlineHandlers()` - 监听并清理动态内容
- `sanitizeAltText(rawName)` - 清理图片alt文本

**侧边栏拖拽模块** (`src/ui/resizer.js`):
- `initOutlineResizer(editorElement, vditorInstance)` - 初始化大纲拖拽
- 支持 MutationObserver 监听动态内容

#### 主入口函数 (`src/main.js`)
- `initEditor()` - 初始化Vditor编辑器
- `getInitialEditorContent()` - 获取初始内容
- `executeWithEditor(executor, onError)` - 安全执行编辑器操作
- `setupElectronHandlers()` - 设置Electron事件处理器
- `setupBrowserFallbacks()` - 设置浏览器回退功能
- `persistContentToLocalStorage(content)` - 本地存储持久化
- `fixPreviewTooltipBehavior()` - 修复预览按钮行为

## 状态管理

### 主进程状态变量
- `currentFilePath: string | null` - 当前文件路径
- `hasUnsavedChanges: boolean` - 是否有未保存更改
- `pendingQuitAfterSave: boolean` - 等待保存后退出
- `isAppQuitting: boolean` - 应用正在退出

### 渲染进程状态变量
- `isEditorDirty: boolean` - 编辑器脏状态
- `knownFilePath: string | null` - 已知文件路径
- `autoSaveTimer: number | null` - 自动保存定时器
- `suppressDirtyTracking: boolean` - 临时禁用脏状态跟踪

## 数据流分析

### 文件打开流程
1. 用户触发打开操作
2. 主进程显示文件对话框
3. 验证文件路径安全性
4. 读取文件内容
5. 通过IPC发送到渲染进程
6. 渲染进程更新编辑器内容

### 文件保存流程
1. 用户触发保存操作
2. 渲染进程获取编辑器内容
3. 通过IPC发送到主进程
4. 主进程处理保存逻辑
5. 写入文件系统
6. 更新状态并反馈

### 自动保存机制
- **Electron环境**: 延迟3秒，最小间隔10秒
- **浏览器环境**: 延迟1.5秒，使用localStorage
- **保存位置**: 原文件或autosave文件夹

## 错误处理机制

### 文件系统错误
- 使用 `translateFileSystemError()` 转换错误消息
- 通过 `buildErrorResponse()` 构建标准化响应
- 显示用户友好的错误提示

### 编辑器错误
- `renderInitError()` 渲染初始化错误界面
- 提供重试机制
- 详细的错误日志记录

## 安全考虑

### 路径安全
- 禁止访问系统目录 (`/System/`, `C:/Windows` 等)
- 文件大小限制 (10MB)
- 路径规范化处理

### CSP 合规
- 禁用内联事件处理器
- 清理第三方库注入的脚本
- 安全的图片上传处理

## 构建和部署

### 开发环境
```bash
npm run dev          # 启动Vite开发服务器
npm run electron:dev # 构建并启动Electron
```

### 生产构建
```bash
npm run build        # 构建渲染进程
npm run electron:dist # 打包Electron应用
```

### 构建配置
- **输出目录**: `release/`
- **应用ID**: `com.wok.editor`
- **产品名称**: `WOK Editor`

## 协作注意事项

### 代码审查要点
1. **IPC通信安全**: 确保所有IPC通道都有适当的验证
2. **文件路径安全**: 使用 `assertSafeFilePath()` 验证所有路径
3. **错误处理**: 统一使用错误响应格式
4. **状态同步**: 确保主进程和渲染进程状态一致

### 扩展开发指南
1. **添加新IPC通道**:
   - 在主进程注册处理器
   - 在预加载脚本暴露API
   - 在渲染进程添加事件处理

2. **添加新菜单项**:
   - 在 `buildMenuTemplate()` 中添加菜单项
   - 添加对应的处理函数

3. **修改编辑器配置**:
   - 在 `initEditor()` 中修改Vditor配置
   - 注意CSP安全限制

### 调试技巧
- 开发环境启用DevTools
- 使用 `console.info()` 记录关键操作
- 检查IPC通信日志

## 性能优化

### 内存管理
- 及时清除定时器
- 合理使用事件监听器
- 避免内存泄漏

### 响应性优化
- 使用防抖机制
- 异步文件操作
- 合理的自动保存间隔

## 重构路线图

### 已完成模块（第一阶段 + 第二阶段部分）
- ✅ `src/core/constants.js` - 配置常量提取
- ✅ `src/ui/toast.js` - Toast组件提取
- ✅ `src/ui/sanitizer.js` - DOM安全处理提取
- ✅ `src/ui/resizer.js` - 侧边栏拖拽提取
- **代码减少**: 231行（-20.3%）

### 待完成模块（第二阶段 + 第三阶段）
- ⏳ `src/core/state.js` - 状态管理集中化
- ⏳ `src/modules/ipc-handlers.js` - IPC处理器提取
- ⏳ `src/modules/file-system.js` - 文件操作逻辑
- ⏳ `src/modules/browser-support.js` - 浏览器兼容逻辑
- ⏳ `src/core/editor.js` - 编辑器核心逻辑

---

**文档版本**: 1.1
**最后更新**: 2025-11-09
**维护者**: 协作工程师团队